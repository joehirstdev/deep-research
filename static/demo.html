<!DOCTYPE html>
<html>
<head>
    <title>Research Agent Demo</title>
    <style>
        body { font-family: system-ui; max-width: 900px; margin: 40px auto; padding: 0 20px; }
        #query { width: 100%; padding: 12px; font-size: 16px; margin-bottom: 12px; }
        button { padding: 12px 24px; font-size: 16px; cursor: pointer; background: #0066cc; color: white; border: none; border-radius: 4px; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #output { margin-top: 20px; }
        .event { padding: 12px; margin: 8px 0; border-left: 3px solid #0066cc; background: #f5f5f5; border-radius: 4px; }
        .progress { border-left-color: #ff9800; }
        .plan { border-left-color: #4caf50; background: #e8f5e9; }
        .sub_result { border-left-color: #2196f3; }
        .final { border-left-color: #9c27b0; background: #f3e5f5; font-weight: 500; }
        .complete { border-left-color: #4caf50; background: #e8f5e9; }
        .error { border-left-color: #f44336; background: #ffebee; color: #c62828; }
        .timestamp { color: #666; font-size: 12px; }
        pre { white-space: pre-wrap; margin: 8px 0; }
        .sources { margin-top: 8px; font-size: 13px; }
        .sources a { color: #0066cc; text-decoration: none; display: block; margin: 4px 0; }
        .sources a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <h1>Multi-Agent Research System</h1>
    <input type="text" id="query" placeholder="Enter your research query..." />
    <button id="submit">Research</button>
    <div id="output"></div>

    <script>
        const queryInput = document.getElementById('query');
        const submitBtn = document.getElementById('submit');
        const output = document.getElementById('output');

        submitBtn.addEventListener('click', async () => {
            const query = queryInput.value.trim();
            if (!query) return;

            output.innerHTML = '';
            submitBtn.disabled = true;

            try {
                const response = await fetch('http://localhost:8000/research/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const event = JSON.parse(line.slice(6));
                            handleEvent(event);
                        }
                    }
                }
            } catch (error) {
                output.innerHTML += `<div class="event error">Error: ${error.message}</div>`;
            } finally {
                submitBtn.disabled = false;
            }
        });

        function handleEvent(event) {
            const timestamp = new Date().toLocaleTimeString();
            let html = '';

            switch (event.type) {
                case 'progress':
                    html = `<div class="event progress">
                        <div class="timestamp">${timestamp}</div>
                        <div>${event.message}</div>
                    </div>`;
                    break;

                case 'plan':
                    html = `<div class="event plan">
                        <div class="timestamp">${timestamp}</div>
                        <strong>Research Plan (${event.total} questions):</strong>
                        <ol>${event.sub_questions.map(q => `<li>${q}</li>`).join('')}</ol>
                        <em>${event.reasoning}</em>
                    </div>`;
                    break;

                case 'question':
                    html = `<div class="event sub_result" id="question-${event.index}">
                        <div class="timestamp">${timestamp}</div>
                        <strong>Question ${event.index}/${event.total}: ${event.question}</strong>
                    </div>`;
                    break;

                case 'sources':
                    const sourcesList = event.sources.map((url, i) =>
                        `<a href="${url}" target="_blank">[${i+1}] ${url}</a>`
                    ).join('');
                    const questionBox = document.getElementById(`question-${event.index}`);
                    if (questionBox) {
                        questionBox.innerHTML += `
                            <div class="sources" style="margin-top: 8px;">
                                <strong>Sources (${event.sources.length}):</strong>
                                ${sourcesList}
                            </div>`;
                        return; // Don't append as new box
                    }
                    break;

                case 'answer':
                    const answerBox = document.getElementById(`question-${event.index}`);
                    if (answerBox) {
                        answerBox.innerHTML += `
                            <div style="margin-top: 8px;">
                                <strong>Answer:</strong>
                                <pre style="margin: 4px 0;">${event.answer}</pre>
                            </div>`;
                        return; // Don't append as new box
                    }
                    break;

                case 'all_sources':
                    const allSourcesList = event.sources.map((url, i) =>
                        `<a href="${url}" target="_blank">[${i+1}] ${url}</a>`
                    ).join('');
                    html = `<div class="event complete">
                        <div class="timestamp">${timestamp}</div>
                        <strong>ðŸ“š All Research Sources (${event.total})</strong>
                        <div class="sources">
                            ${allSourcesList}
                        </div>
                    </div>`;
                    break;

                case 'final':
                    html = `<div class="event final">
                        <div class="timestamp">${timestamp}</div>
                        <strong>Final Answer:</strong>
                        <pre>${event.answer}</pre>
                    </div>`;
                    break;

                case 'complete':
                    html = `<div class="event complete">
                        <div class="timestamp">${timestamp}</div>
                        âœ“ Research complete (${event.total_sub_questions} questions)
                    </div>`;
                    break;

                case 'error':
                    html = `<div class="event error">
                        <div class="timestamp">${timestamp}</div>
                        Error: ${event.message}
                    </div>`;
                    break;
            }

            output.innerHTML += html;
            output.scrollTop = output.scrollHeight;
        }

        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitBtn.click();
        });
    </script>
</body>
</html>
